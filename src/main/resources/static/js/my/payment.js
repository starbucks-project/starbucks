async function myFunction(str) {
  console.log("0");
  alert("내카드: "+ str + " 을 선택하였습니다." );
  let cardId=$("#cardNum_NORMAL option:selected").val();
  console.log("cardId:"+cardId);
  //cardInfo(cardId);
  console.log("1");
  
  console.log("2");
  
  let response = await fetch("/user/cardInfo/"+cardId, {
    method: "get"
  });

  console.log("3");
  let parseResponse = await response.json();

  console.log(parseResponse);

  if(parseResponse.code === 1){
      console.log("4");
      $(".user_card_wrap").remove();
      console.log("5");
      let boxEL=document.querySelector(".sel_box");
      
      let popupItem = document.createElement("div");
      popupItem.className = "user_card_wrap";
      
      let temp =`
      <figure>
      <i class="representative_icon"><a
      href="javascript:void(0);"></a></i>
      <img alt="" class="cardImgUrl"
      onerror="this.src='https://image.istarbucks.co.kr/upload/common/img/icon/card_672x423.png';"
      src="https://image.istarbucks.co.kr/cardImg/20190805/005949.png">
      </figure>
      <p>
      <strong class="en cardNum">${parseResponse.data.cardNum}</strong><br>
      <br> 최종 사용일 : 
      <span class="balanceConfirmDate">2021-07-08 13:31:00</span>
      <br> 카드 등록일 : <span class="cardRegDate">${parseResponse.data.createDate}</span>
      </p>
      `;
      
      popupItem.innerHTML = temp;
      boxEL.append(popupItem);
      

  } else {
      alert("cardInfo 뿌리기 실패");
  }
}

//async function cardInfo(cardId) {}
/*=====================================================================*/



function chargepay() {

  let buyername = document.querySelector("#principalname").value;
  let buyeremail = document.querySelector("#principalemail").value;
  let buyertel = document.querySelector("#principaltel").value;

  let produtname = $("#cardNum_NORMAL option:selected").text();
  let cardid = $("#cardNum_NORMAL option:selected").val();
  let productamount = document.querySelector(".charge").value;

  let payreqDto = {
    amount: productamount,
    cardid: cardid,
  };
  var IMP = window.IMP; // 생략 가능
  IMP.init("imp68218098"); // 예: imp00000000s
  // IMP.request_pay(param, callback) 결제창 호출
  IMP.request_pay(
    {
      // param
      // param
      pg: "html5_inicis",
      pay_method: "card",
      merchant_uid: "merchant_" + new Date().getTime(), // 주문번호
      name: produtname,
      amount: productamount, // 값
      buyer_email: buyeremail, // session 값
      buyer_name: buyername, // session 값
      buyer_tel: buyertel, // session 값
    },
    (rsp) => {
      // callback
      if (rsp.success) {
        console.log("결제 성공");
        console.log(rsp);
        // 결제 성공 시 로직,
        successCharge(payreqDto);

        /*
        jQuery
          .ajax({
            url: "/user/cardCharge/complete", // 예: https://www.myservice.com/payments/complete 가맹점 서버
            method: "post",
            headers: { "Content-Type": "application/json" },
            data: {
              imp_uid: rsp.imp_uid,
              merchant_uid: rsp.merchant_uid,
              buyername: buyername,
              buyeremail: buyeremail,
              o_paytype: rsp.pay_method,
            },
          })
          .done(function (data) {
            if (everythings_fine) {
              var msg = "결제가 완료되었습니다.";
              msg += "\n고유ID : " + rsp.imp_uid;
              msg += "\n상점 거래ID : " + rsp.merchant_uid;
              msg += "결제 금액 : " + rsp.paid_amount;
              msg += "카드 승인번호 : " + rsp.apply_num;

              alert(msg);
              document.location.href = "/user/mypage"; 
            } else {
              //[3] 아직 제대로 결제가 되지 않았습니다.
              //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
            } 
          });                                                  
              document.location.href = "/user/mypage";
            } else {
              //[3] 아직 제대로 결제가 되지 않았습니다.
              //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
            }
          });         */
      } else {
        console.log(rsp);
        alert("결제에 실패하였습니다. 에러 내용: " + rsp.error_msg);
      }
    }
  );
}

async function  successCharge(payreqDto) {
  console.log("확인", payreqDto);
  console.log("결제 성공시, 로직 start!");
  let response = await fetch("/user/cardCharge/complete", {
    method: "post",
    body: JSON.stringify(payreqDto),
    headers: {
      "Content-Type": "application/json; charset=utf-8",
    },
  });

  console.log("controller완료!!!");
  location.href = "/user/mypage";
} //결제 성공시 실행되는 함수 end
/*=================================================================================================*/

function egiftpay() {
  let buyername = document.querySelector("#principalname").value;
  let buyeremail = document.querySelector("#principalemail").value;
  let buyertel = document.querySelector("#principaltel").value;

  let price = document.querySelector("#price").value;

  let receiver = document.querySelector("#receiver").value;
  let phone1 = $("#phone1 option:selected").val();
  let phone2 = document.querySelector("#phone2").value;
  let phone3 = document.querySelector("#phone3").value;
  let reqMsg = document.querySelector("#reqMsg").value;

  let cardcartreqDto = {
    price: price,
    receiver: receiver,
    phone1: phone1,
    phone2: phone2,
    phone3: phone3,
    reqMsg: reqMsg
  }

  // IMP.request_pay(param, callback) 호출
  var IMP = window.IMP; // 생략 가능
  IMP.init("imp68218098"); // 예: imp00000000s
  // 변수화
  IMP.request_pay(
    {
      // param
      pg: "html5_inicis",
      pay_method: "card",
      merchant_uid: "merchant_" + new Date().getTime(), // 주문번호
      name: "e-gift",
      amount: price, // 값
      buyer_email: buyeremail, // session 값
      buyer_name: buyername, // session 값
      buyer_tel: buyertel, // session 값
    },
    (rsp) => {
      // callback
      if (rsp.success) {
        // 결제 성공 시: 결제 승인 또는 가상계좌 발급에 성공한 경우
        // axios로 HTTP 요청
        // jQuery로 HTTP 요청
        /*
        jQuery
          .ajax({
            url: "/payments/complete", // 예: https://www.myservice.com/payments/complete 가맹점 서버
            method: "POST",
            headers: { "Content-Type": "application/json" },
            data: {
              imp_uid: rsp.imp_uid,
              merchant_uid: rsp.merchant_uid,
              buyer_name: rsp.buyer_name,
              buyer_email: rsp.buyer_email,
            },
          })
          .done(function (data) {
            if (everythings_fine) {
              var msg = "결제가 완료되었습니다.";
              msg += "\n고유ID : " + rsp.imp_uid;
              msg += "\n상점 거래ID : " + rsp.merchant_uid;
              msg += "결제 금액 : " + rsp.paid_amount;
              msg += "카드 승인번호 : " + rsp.apply_num;

              alert(msg);
            } else {
              //[3] 아직 제대로 결제가 되지 않았습니다.
              //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
            }
          });
          */
        console.log("결제 성공");
        console.log(rsp);
      // 결제 성공 시 로직,
      successEgift(cardcartreqDto);
      } else {
        console.log("결제 실패");
        console.log(rsp);
        // 결제 실패 시 로직,
        alert("결제를 실패했습니다.");
      }
    }
  );
}

async function  successEgift(cardcartreqDto) {
  console.log("확인", cardcartreqDto);
  console.log("결제 성공시, 로직 start!");
  let response = await fetch("/user/egift/complete", {
    method: "post",
    body: JSON.stringify(cardcartreqDto),
    headers: {
      "Content-Type": "application/json; charset=utf-8",
    },
  });

  alert("controller완료!!!");
  location.href = "/user/purchaseHistory";
} //결제 성공시 실행되는 함수 end
/*======================================================*/
//Cart 선택된 최종 결제 금액
let arrProductId = new Array();
$(".ez-checked").each(function () {
  arrProductId.push($(this).attr("id"));
});

/*======================================================*/
function cartpay() {
  console.log("cartpay()함수 실행");
  const IMP = window.IMP; // 생략해도 괜찮습니다.
  IMP.init("imp68218098"); // "imp00000000" 대신 발급받은 "가맹점 식별코드"를 사용합니다.

  let buyername = document.querySelector("#principalname").value;
  let buyeremail = document.querySelector("#principalemail").value;
  let buyertel = document.querySelector("#principaltel").value;

  let length = $(".ez-checked").length;
  let arrProductId = new Array();
  $(".ez-check").each(function () {
    arrProductId.push($(this).attr("id"));
  });

  let arrCartId = new Array();
  $(".ez-checked").each(function () {
    arrCartId.push($(this).attr("id"));
  });

  let id_str;
  for (let index = 0; index < length; index++) {
    id_str = id_str + arrProductId[index];
  } // ["0", "4", "5"] => "045"

  let merchantuid = id_str; //선택된 상품들의 아이디
  let produtname = arrProductId; //상품이름
  let productamount = document.querySelector(".checkedTotalAmount").textContent; //결제금액

  let price;

  let saledReqDto = {
    arrProductId: arrProductId, //productId
    arrCartId: arrCartId, // cartId
    length: length,
    applyNum: "",
  };

  // IMP.request_pay(param, callback) 호출
  // 변수화
  IMP.request_pay(
    {
      // param
      pg: "html5_inicis",
      pay_method: "card",
      merchant_uid: "merchant_" + new Date().getTime(), // 주문번호
      name: produtname + "장바구니 상품결제",
      amount: productamount, // 값 - 결제금액
      buyer_email: buyeremail, // session 값
      buyer_name: buyername, // session 값
      buyer_tel: buyertel, // session 값
    },
    (rsp) => {
      // callback
      if (rsp.success) {
        console.log("결제 성공");
        console.log(rsp);
        // 결제 성공 시 로직,
        saledReqDto.applyNum = rsp.apply_num;
        success(saledReqDto);
      } else {
        console.log(rsp);
        alert("결제에 실패하였습니다. 에러 내용: " + rsp.error_msg);
      }
    }
  );
}
async function success(saledReqDto) {
  console.log("확인", saledReqDto);
  console.log("결제 성공시, 로직 start!");
  alert(saledReqDto.arrProductId);
  let response = await fetch("/user/purchaseHistory", {
    method: "post",
    body: JSON.stringify(saledReqDto),
    headers: {
      "Content-Type": "application/json; charset=utf-8",
    },
  });

  location.href = "/user/purchaseHistory";
} //결제 성공시 실행되는 함수 end

/*=======================================================================*/

// // 가맹점 서버 코드(?)
// app.use(bodyParser.json());
// // "/payments/complete"에 대한 POST 요청을 처리
// app.post("/user/mypage/point", async (req, res) => {
//   try {
//     const { imp_uid, merchant_uid } = req.body; // req의 body에서 imp_uid, merchant_uid 추출

//     // 액세스 토큰(access token) 발급 받기
//     const getToken = await axios({
//       url: "https://api.iamport.kr/users/getToken",
//       method: "post", // POST method
//       headers: { "Content-Type": "application/json" }, // "Content-Type": "application/json"
//       data: {
//         imp_key: "6123528723609391", // REST API키
//         imp_secret:
//           "bcf4c659bb721796a41accc009c841574611cf922e67c1a9ae8eed5777db209fe0987ad5849d8b73", // REST API Secret
//       },
//     });
//     const { access_token } = getToken.data.response; // 인증 토큰

//     // imp_uid로 아임포트 서버에서 결제 정보 조회
//     const getPaymentData = await axios({
//       url: `https://api.iamport.kr/payments/${imp_uid}`, // imp_uid 전달
//       method: "get", // GET method
//       headers: { Authorization: access_token }, // 인증 토큰 Authorization header에 추가
//     });
//     const paymentData = getPaymentData.data.response; // 조회한 결제 정보

//     // DB에서 결제되어야 하는 금액 조회
//     const order = await Orders.findById(paymentData.merchant_uid);
//     const amountToBePaid = order.amount; // 결제 되어야 하는 금액

//     // 결제 검증하기
//     const { amount, status } = paymentData;
//     if (amount === amountToBePaid) {
//       // 결제 금액 일치. 결제 된 금액 === 결제 되어야 하는 금액
//       await Orders.findByIdAndUpdate(merchant_uid, { $set: paymentData }); // DB에 결제 정보 저장

//       switch (status) {
//         case "ready": // 가상계좌 발급
//           // DB에 가상계좌 발급 정보 저장
//           const { vbank_num, vbank_date, vbank_name } = paymentData;
//           await Users.findByIdAndUpdate(`${principal.id}` /* 고객 id */, {
//             $set: { vbank_num, vbank_date, vbank_name },
//           });
//           // 가상계좌 발급 안내 문자메시지 발송
//           SMS.send({
//             text: `가상계좌 발급이 성공되었습니다. 계좌 정보 ${vbank_num} \${vbank_date} \${vbank_name}`,
//           });
//           res.send({ status: "vbankIssued", message: "가상계좌 발급 성공" });
//           break;
//         case "paid": // 결제 완료
//           res.send({ status: "success", message: "일반 결제 성공" });
//           break;
//       }
//     } else {
//       // 결제 금액 불일치. 위/변조 된 결제
//       throw { status: "forgery", message: "위조된 결제시도" };
//     }
//   } catch (e) {
//     res.status(400).send(e);
//   }
// });
/*================================================================================*/
// Cart.jsp "선택상품 결제하기"
function cartpay2() {
  let cardId= $("#cardNum_NORMAL_sel option:selected").val();              //결제할 카드 아이디
  if(cardId===null || cardId==="") {
      alert("결제할 카드를 선택해주세요");
      return false;
  }

  console.log('1');

  let length = $(".ez-checked").length;
  let arrProductId = new Array();
  $(".ez-check").each(function () {
    arrProductId.push($(this).attr("id"));
  });

  let arrCartId = new Array();
  $(".ez-checked").each(function () {
    arrCartId.push($(this).attr("id"));
  });

  let productamount = document.querySelector(".checkedTotalAmount").textContent; //결제금액

  let saledReqDto = {
    arrProductId: arrProductId, //productId
    arrCartId: arrCartId, // cartId
    length: length,
    productamount: productamount,
    cardId: cardId
  };

  console.log("2");
  success2(saledReqDto);
  
}

async function success2(saledReqDto) {
  console.log("확인", saledReqDto);
  alert("결제금액:"+saledReqDto.productamount);
  let response = await fetch("/user/purchaseHistory", {
    method: "post",
    body: JSON.stringify(saledReqDto),
    headers: {
      "Content-Type": "application/json; charset=utf-8",
    }
  });

  let parseResponse = await response.json();

console.log(parseResponse);

if(parseResponse.code === 0){
  alert(parseResponse.msg);
  return false;
}
  
  alert("결제 성공");
  location.href = "/user/purchaseHistory";
} //결제 성공시 실행되는 함수 end

/*================================================================================*/
// Cart.jsp "전체상품 결제하기"
function cartpay3() {
  let cardId= $("#cardNum_NORMAL_sel option:selected").val();              //결제할 카드 아이디
  if(cardId===null || cardId==="") {
      alert("결제할 카드를 선택해주세요");
      return false;
  }

  console.log('1');
  allcheck();

  
  let length = $(".ez-checked").length;
  let arrProductId = new Array();
  $(".ez-check").each(function () {
    arrProductId.push($(this).attr("id"));
  });

  let arrCartId = new Array();
  $(".ez-checked").each(function () {
    arrCartId.push($(this).attr("id"));
  });

  let productamount = document.querySelector(".checkedTotalAmount").textContent; //결제금액

  let saledReqDtoAll = {
    arrProductId: arrProductId, //productId
    arrCartId: arrCartId, // cartId
    length: length,
    productamount: productamount,
    cardId: cardId
  };

  console.log("2");
  success2(saledReqDtoAll);
  
}